diff -r -u -N -X /tmp/exclude /opt.orig/SUNWkio/bin/kioskconfig /opt/SUNWkio/bin/kioskconfig
--- /opt.orig/SUNWkio/bin/kioskconfig	2011-04-23 07:57:24.000000000 +0200
+++ /opt/SUNWkio/bin/kioskconfig	2011-08-08 16:10:31.447864025 +0200
@@ -190,7 +190,7 @@
 
  theDisplayFile="$KIOSK_VAR_DIR/config/$inDisplay"
  if [ -f $theDisplayFile ] ; then
-  theEnabledState=`sed -n 's/^KIOSK_ENABLED=//p' $theDisplayFile | tail -1`
+  theEnabledState=`sed -n 's/^KIOSK_ENABLED=//p' $theDisplayFile | tail -n 1`
   if [ -n "$theEnabledState" ] ; then
    if [ $theEnabledState = "yes" ] ; then
     echo $inDisplay
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWkio/lib/gdm/kioskgreeter /opt/SUNWkio/lib/gdm/kioskgreeter
--- /opt.orig/SUNWkio/lib/gdm/kioskgreeter	2011-04-23 07:57:24.000000000 +0200
+++ /opt/SUNWkio/lib/gdm/kioskgreeter	2011-08-08 16:10:31.447864025 +0200
@@ -27,7 +27,7 @@
 #
 
 theModule=kiosk:kioskgreeter
-theDefaultGreeter=/usr/bin/gdmgreeter
+theDefaultGreeter=/usr/lib/gdm/gdmgreeter
 
 #
 ## processGDMInput acts as a fake gdm greeter. It consumes gdm requests and
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWut/bin/utset /opt/SUNWut/bin/utset
--- /opt.orig/SUNWut/bin/utset	2011-06-04 00:27:48.000000000 +0200
+++ /opt/SUNWut/bin/utset	2011-08-08 16:10:31.427863961 +0200
@@ -881,7 +881,7 @@
       print "$R $S"
     done
   ) |
-  (export LC_ALL=C; sort -t 'x' +0 -1n +1 -2n +2 -3n)
+  (export LC_ALL=C; sort -t 'x' -k 1,1n -k 2,2n -k 3,3n )
 
   exit 0
 fi
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWut/lib/dhcp/isc/dhcp_config_linux /opt/SUNWut/lib/dhcp/isc/dhcp_config_linux
--- /opt.orig/SUNWut/lib/dhcp/isc/dhcp_config_linux	2011-06-04 00:27:48.000000000 +0200
+++ /opt/SUNWut/lib/dhcp/isc/dhcp_config_linux	2011-08-08 16:10:31.427863961 +0200
@@ -7,7 +7,11 @@
 #
 
 UTDHCPDIR="$ETCDIR"/net/dhcp
-DHCPDCONF=/etc/dhcpd.conf
+if [[ -f "/etc/dhcp/dhcpd.conf" ]]; then
+ DHCPDCONF=/etc/dhcp/dhcpd.conf
+else
+ DHCPDCONF=/etc/dhcpd.conf
+fi
 UTDHCPFILE="$UTDHCPDIR"/utdhcp
 OPTIONSFILENAME="SunRay-options"
 OPTIONSFILE="$UTDHCPDIR"/"$OPTIONSFILENAME"
@@ -30,9 +34,13 @@
 DUMMY_SUBNET_COMMENT="# Sun Ray: dummy subnet to support DHCP clients on remote subnets"
 
 CheckChrooted() {
-	grep $CHROOTKEY $SYSDHCPD | grep -i yes 2>/dev/null 1>&2
-	if [[ $? -eq 0 ]]; then
-		CHROOTED=true
+	if [[ -f $SYSDHCPD ]]; then
+		grep $CHROOTKEY $SYSDHCPD | grep -i yes 2>/dev/null 1>&2
+		if [[ $? -eq 0 ]]; then
+			CHROOTED=true
+		else
+			CHROOTED=false
+		fi
 	else
 		CHROOTED=false
 	fi	
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWut/lib/dhcp/isc/utdhcpservice /opt/SUNWut/lib/dhcp/isc/utdhcpservice
--- /opt.orig/SUNWut/lib/dhcp/isc/utdhcpservice	2011-06-04 00:27:48.000000000 +0200
+++ /opt/SUNWut/lib/dhcp/isc/utdhcpservice	2011-08-08 16:10:31.427863961 +0200
@@ -49,14 +49,15 @@
 
 # names of files and directories that will be touched by this script
 #
-DHCP_CONFIG="/etc/dhcpd.conf";
+DHCP_CONFIG="/etc/dhcp/dhcpd.conf";
 DHCP_CONFIG_SAMPLE_RHAS="/usr/share/doc/dhcp-3.0.1/dhcpd.conf.sample";
 DHCP_CONFIG_SAMPLE_SLES="/usr/share/doc/packages/dhcp-server/dhcpd.conf";
+DHCP_CONFIG_SAMPLE_DEB="/usr/share/doc/isc-dhcp-server/examples/dhcpd.conf";
 TMPDIR="/var/opt/SUNWut/tmp"
 CORONA_NAME="SunRay";
 CORONA_TITLE="Sun Ray";
-if [ -d /var/lib/dhcp ]; then
-	DHCP_DIR="/var/lib/dhcp";
+if [ -d /var/lib/dhcp ]; then
+	DHCP_DIR="/var/lib/dhcp";
 elif [ -d /var/lib/dhcpd ]; then
 	 DHCP_DIR="/var/lib/dhcpd";
 fi
@@ -76,6 +77,7 @@
 typeset DHCP_RUNNING=true
 typeset DHCP_PACKAGE_RH="dhcp"
 typeset DHCP_PACKAGE_SU="dhcp-server"
+typeset DHCP_PACKAGE_SU="dhcp3-server"
 typeset DHCP_PACKAGE="DHCP"
 typeset DHCP_STATE="online"
 
@@ -97,7 +99,12 @@
     typeset PACKAGE="${DHCP_PACKAGE}"
     if $DHCP_INSTALLED ; then
       # get the actual package name including version and release
-      PACKAGE="$(rpm -q ${DHCP_PACKAGE} 2> /dev/null)"
+      DPKG=$(which dpkg1)
+      if [[ -f "$DPKG" ]]; then
+      	PACKAGE="$(dpkg -l | grep dhcp3-server | awk '{print $2$3}' 2> /dev/null)"
+      else
+      	PACKAGE="$(rpm -q ${DHCP_PACKAGE} 2> /dev/null)"
+      fi
     fi
     if ! $DHCP_RUNNING && [ $DHCP_STATE != "unconfigured" ] ; then
       DHCP_STATE="disabled"
@@ -122,12 +129,18 @@
           DHCP_CONFIG_SAMPLE=${DHCP_CONFIG_SAMPLE_RHAS}
        elif [ -f ${DHCP_CONFIG_SAMPLE_SLES} ]; then
            DHCP_CONFIG_SAMPLE=${DHCP_CONFIG_SAMPLE_SLES}
+       elif [ -f ${DHCP_CONFIG_SAMPLE_DEB} ]; then
+           DHCP_CONFIG_SAMPLE=${DHCP_CONFIG_SAMPLE_DEB}
        fi
        diff ${DHCP_CONFIG} ${DHCP_CONFIG_SAMPLE} > /dev/null 2>&1
        if [[ $? == 0 ]]; then
             mv ${DHCP_CONFIG} ${DHCP_CONFIG}.sunray
        else
-	   dhcpd -t > /dev/null 2>&1
+	   if [[ -f "/usr/sbin/dhcpd3" ]]; then
+		dhcpd3 -t > /dev/null 2>&1
+	   else
+		dhcpd -t > /dev/null 2>&1
+	   fi
 	   if [[ $? == 0 ]]; then
 		cat > ${DHCP_CONFIG}.$$ <<-!
 # ${SUNRAY_FILE_MARK} /etc/dhcpd.conf
@@ -208,7 +221,11 @@
       return 3
     fi
 
-    /etc/init.d/dhcpd start > /dev/null 2>&1
+    if [[ -f /etc/init.d/isc-dhcp-server ]]; then
+	/etc/init.d/isc-dhcp-server start > /dev/null 2>&1
+    else
+	/etc/init.d/dhcpd start > /dev/null 2>&1
+    fi
     return $?
 }
 
@@ -217,7 +234,11 @@
       return 3
     fi
 
-    /etc/init.d/dhcpd stop > /dev/null 2>&1
+    if [[ -f /etc/init.d/isc-dhcp-server ]]; then
+    	/etc/init.d/isc-dhcp-server stop > /dev/null 2>&1
+    else
+    	/etc/init.d/dhcpd stop > /dev/null 2>&1
+    fi
     return $?
 }
 
@@ -226,7 +247,11 @@
       return 3
     fi
 
-    /etc/init.d/dhcpd restart > /dev/null 2>&1
+    if [[ -f /etc/init.d/isc-dhcp-server ]]; then
+    	/etc/init.d/isc-dhcp-server restart > /dev/null 2>&1
+    else
+    	/etc/init.d/dhcpd restart > /dev/null 2>&1
+    fi
     return $?
 }
 
@@ -237,11 +262,16 @@
 if [[ $? -ne 0 ]] ; then
   ${UT_BASEDIR}/lib/utprodinfo -t installed ${DHCP_PACKAGE_SU} 2>/dev/null 1>&2
   if [[ $? -ne 0 ]]; then
-    DHCP_INSTALLED=false
-    DHCP_ENABLED=false
-    DHCP_CONFIGURED=false
-    DHCP_RUNNING=false
-    DHCP_STATE="uninstalled"
+    ${UT_BASEDIR}/lib/utprodinfo -t installed ${DHCP_PACKAGE_DEB} 2>/dev/null 1>&2
+    if [[ $? -ne 0 ]]; then  
+      DHCP_INSTALLED=false
+      DHCP_ENABLED=false
+      DHCP_CONFIGURED=false
+      DHCP_RUNNING=false
+      DHCP_STATE="uninstalled"
+    else
+      DHCP_PACKAGE=${DHCP_PACKAGE_DEB}
+    fi
   else
     DHCP_PACKAGE=${DHCP_PACKAGE_SU}
   fi
@@ -267,7 +297,11 @@
       	    DHCP_CONFIGURED=false	# Interface / subnet not defined
     	fi
 
-    	/etc/init.d/dhcpd status 2> /dev/null | grep "running" >/dev/null 2>&1
+    	if [[ -f "/etc/init.d/isc-dhcp-server" ]]; then
+		/etc/init.d/isc-dhcp-server status 2> /dev/null | grep "running" >/dev/null 2>&1
+    	else
+		/etc/init.d/dhcpd status 2> /dev/null | grep "running" >/dev/null 2>&1
+    	fi
     	if [[ $? -ne 0 ]]; then
       	    DHCP_RUNNING=false
     	fi
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWut/lib/iu_modules/M10SunDS /opt/SUNWut/lib/iu_modules/M10SunDS
--- /opt.orig/SUNWut/lib/iu_modules/M10SunDS	2011-06-04 00:50:04.000000000 +0200
+++ /opt/SUNWut/lib/iu_modules/M10SunDS	2011-08-08 16:10:31.427863961 +0200
@@ -98,7 +98,7 @@
           # NOTE: head -2 to deal with the case the first line is blank.
           # we need only to know if there is anything under the subtree.
           #
-          ANY=$(ldapsearch -b "$BASE" -s one "objectclass=*" dn 2>&- | head -2)
+          ANY=$(ldapsearch -b "$BASE" -s one "objectclass=*" dn 2>&- | head -n 2)
           search_st=$?
           if [[ $search_st -eq 0 ]]; then
             # subtree exists, check if empty
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWut/lib/iu_modules/M40AuthMgr /opt/SUNWut/lib/iu_modules/M40AuthMgr
--- /opt.orig/SUNWut/lib/iu_modules/M40AuthMgr	2011-06-04 00:50:04.000000000 +0200
+++ /opt/SUNWut/lib/iu_modules/M40AuthMgr	2011-08-08 16:10:31.427863961 +0200
@@ -285,19 +285,19 @@
 
     # try to set keyval to uncommented pair first
     old_keyval=$(grep "=" $oldfile 2>&- |
-        grep "^[ 	]*${key}[= 	]" | tail -1)
+        grep "^[ 	]*${key}[= 	]" | tail -n 1)
     # if no uncommented pair, take the last commented pair
     [[ -z "$old_keyval" ]] && \
       old_keyval=$(grep "=" $oldfile 2>&- |
-      grep "^[# 	]*${key}[= 	]" | tail -1)
+      grep "^[# 	]*${key}[= 	]" | tail -n 1)
 
     # try to set keyval to uncommented pair first
     new_keyval=$(grep "=" $newfile 2>&- |
-        grep "^[ 	]*${key}[= 	]" | tail -1)
+        grep "^[ 	]*${key}[= 	]" | tail -n 1)
     # if no uncommented pair, take the last commented pair
     [[ -z "$new_keyval" ]] && \
       new_keyval=$(grep "=" $newfile 2>&- |
-      grep "^[# 	]*${key}[= 	]" | tail -1)
+      grep "^[# 	]*${key}[= 	]" | tail -n 1)
 
 #
 # Check if this parameter does not have to be modified
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWut/lib/prototype/Xsetup.SUNWut.prototype /opt/SUNWut/lib/prototype/Xsetup.SUNWut.prototype
--- /opt.orig/SUNWut/lib/prototype/Xsetup.SUNWut.prototype	2011-06-04 00:27:48.000000000 +0200
+++ /opt/SUNWut/lib/prototype/Xsetup.SUNWut.prototype	2011-08-08 16:10:31.427863961 +0200
@@ -276,8 +276,13 @@
 		SESSION_PROC=/tmp/SUNWut/session_proc/$DPY
 		echo XID=$DPY > $SESSION_PROC
 		echo pid=$PPID >> $SESSION_PROC
-		/bin/ps -p $PPID -o comm | sed -n '$s/^/program=/p' \
+		if [ `uname` = "Linux" ]; then
+			/bin/ps -p $PPID -o cmd | /usr/bin/cut -d ' ' -f 1 | sed -n '$s/^/program=/p' \
 							>> $SESSION_PROC
+		else
+			/bin/ps -p $PPID -o comm | sed -n '$s/^/program=/p' \
+							>> $SESSION_PROC
+		fi
 		/bin/chmod 644 $SESSION_PROC
 
 		if [ $REBALANCE -ne 0 ] ; then
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWut/lib/support_lib/iu_lib /opt/SUNWut/lib/support_lib/iu_lib
--- /opt.orig/SUNWut/lib/support_lib/iu_lib	2011-06-04 00:50:05.000000000 +0200
+++ /opt/SUNWut/lib/support_lib/iu_lib	2011-08-08 16:10:31.427863961 +0200
@@ -230,8 +230,8 @@
 
     for patchid in $all_patches; do
       print -n "... checking patch ${patchid} ... "
-      exist=$(grep "${patchid}-[0-9][0-9]" ${showrev_p} | head -1)
-      patch=$(\ls -1 "$dir" 2>&- | grep "^${patchid}" | tail -1)
+      exist=$(grep "${patchid}-[0-9][0-9]" ${showrev_p} | head -n 1)
+      patch=$(\ls -1 "$dir" 2>&- | grep "^${patchid}" | tail -n 1)
       pkgs=$(cd "${dir}/${patch}" 2>&-; \ls -1 */pkginfo 2>&- | 
         sed -e 's:/pkginfo::g')
 
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWut/lib/support_lib/sras_config /opt/SUNWut/lib/support_lib/sras_config
--- /opt.orig/SUNWut/lib/support_lib/sras_config	2011-06-04 00:50:05.000000000 +0200
+++ /opt/SUNWut/lib/support_lib/sras_config	2011-08-08 16:10:31.427863961 +0200
@@ -397,8 +397,8 @@
 				      	      "\nWould you like to use this instance?  Answering \"no\"" \
 				      	      "\nwill configure the /usr/apache instance." ; then
 						APACHETMP="$ETC_OPT_UT"/http/templates/apache.tpl
-  						APACHECTL="/usr/apache/bin/apachectl"	
-						APACHEDIR="/usr/apache/conf"
+  						APACHECTL="/usr/sbin/apache2ctl"
+						APACHEDIR="/etc/apache2"
 						APACHECFG="$APACHEDIR"/httpd.conf
 					fi
 					UT_LOCATION=$APACHEDIR
@@ -580,6 +580,13 @@
 		rm -f /etc/opt/SUNWut/http/auto.start
 	fi
 	print ${APACHECTL} > /etc/opt/SUNWut/http/auto.start
+	if [[ -f /etc/default/apache2 ]]; then
+		. /etc/default/apache2
+		if [[ "$NO_START" = "1" ]]; then
+			echo "# 0 = start on boot; 1 = don't start on boot" > /etc/default/apache2
+			echo "NO_START=0" >> /etc/default/apache2
+		fi
+	fi
 }
 
 function RemoveAutoStart {
@@ -898,6 +905,8 @@
 	if [[ $OS == "Linux" ]]; then
 		if [[ -f /etc/httpd/conf/magic || -f /etc/httpd/magic ]]; then
 			HTTPD_SCRIPT=/usr/sbin/httpd
+		elif [[ -f /etc/apache2/magic ]]; then
+			HTTPD_SCRIPT=/usr/sbin/apache2
 		fi
 	fi
 
@@ -938,6 +947,8 @@
 			BUNDLED_MAGIC=/etc/httpd/conf/magic
 		elif [[ -f /etc/httpd/magic ]]; then
 			BUNDLED_MAGIC=/etc/httpd/magic
+		elif [[ -f /etc/apache2/magic ]]; then
+			BUNDLED_MAGIC=/etc/apache2/magic
 		fi
 		;;
 	esac
@@ -1066,11 +1077,25 @@
 			fi
                 	STATUS=1
         	fi
+	# Check for apache in Debian/Ubuntu location
+	elif [[ -f /etc/apache2/magic ]]; then
+		APACHEDIR="/etc/apache2"
+		APACHETMP="$ETC_OPT_UT"/http/templates/apache.tpl.debian
+		APACHECTL="/etc/init.d/apache2"
 	fi
         ;;
   esac
   if [[ -n $APACHEDIR ]]; then
-  	APACHECFG="$APACHEDIR"/httpd.conf
+  	if [[ "$OS" = "Linux" ]]; then
+		. /etc/lsb-release
+		if [[ "$DISTRIB_ID" = "Ubuntu" ]] || [[ "$DISTRIB_ID" = "Debian" ]]; then
+			APACHECFG="$APACHEDIR"/apache2.conf
+		else
+			APACHECFG="$APACHEDIR"/httpd.conf
+		fi
+	else
+		APACHECFG="$APACHEDIR"/httpd.conf
+	fi
   fi
   ApacheInstalled
 
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWut/lib/support_lib/upgrade_lib /opt/SUNWut/lib/support_lib/upgrade_lib
--- /opt.orig/SUNWut/lib/support_lib/upgrade_lib	2011-06-04 00:50:05.000000000 +0200
+++ /opt/SUNWut/lib/support_lib/upgrade_lib	2011-08-08 16:10:31.437863993 +0200
@@ -56,9 +56,9 @@
   for key in $(awk -F= '{ print $1 }' $oldfile 2>&- | grep -v "^#" |
       sort -u); do
     old_keyval=$(grep "^[ 	]*$key[= 	]" $oldfile 2>&- |
-        tail -1)
+        tail -n 1)
     new_keyval=$(grep "^[ 	]*$key[= 	]" $newfile 2>&- |
-        tail -1)
+        tail -n 1)
     if [[ -n "$old_keyval" && -n "$new_keyval" ]]; then
       if [[ "$old_keyval" != "$new_keyval" ]]; then
         DoUpgrade "$key" "$old_keyval" "$new_keyval" "$newfile"
@@ -116,7 +116,7 @@
   fi
   for key in $(grep -v "^#" "$oldfile" 2>&- | awk -F= '{ print $1 }' |
       sort -u); do
-    line=$(grep "^${key}[ 	=]" "$oldfile" 2>&- | tail -1)
+    line=$(grep "^${key}[ 	=]" "$oldfile" 2>&- | tail -n 1)
     grep "$line" "$newfile" 2>&1 >/dev/null || \
       DoAppend "$line" "$newfile"
   done
@@ -564,7 +564,7 @@
     return 1
   fi
 
-  _RETURN_VAL=$(ls -1 ${TARFILE}* | tail -1)
+  _RETURN_VAL=$(ls -1 ${TARFILE}* | tail -n 1)
 
   return 0
 
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWut/lib/utadmingid /opt/SUNWut/lib/utadmingid
--- /opt.orig/SUNWut/lib/utadmingid	2011-06-04 00:27:48.000000000 +0200
+++ /opt/SUNWut/lib/utadmingid	2011-08-08 16:10:31.437863993 +0200
@@ -15,7 +15,7 @@
 ETCDIR="/etc/opt/SUNWut"
 UTADMINPW=${ETCDIR}/utadmin.pw
 if [ -f $UTADMINPW ] ; then
-	WEBGUI_GROUP=`/bin/ls -gn $UTADMINPW | /bin/awk '{print $3}' `
+	WEBGUI_GROUP=`/bin/ls -gn $UTADMINPW | awk '{print $3}' `
 fi
 WEBGUI_GROUP=${WEBGUI_GROUP:-root}
 print $WEBGUI_GROUP
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWut/lib/utctl.d/features/utcompatlinksctl /opt/SUNWut/lib/utctl.d/features/utcompatlinksctl
--- /opt.orig/SUNWut/lib/utctl.d/features/utcompatlinksctl	2011-06-04 00:27:47.000000000 +0200
+++ /opt/SUNWut/lib/utctl.d/features/utcompatlinksctl	2011-08-08 16:11:55.558136846 +0200
@@ -133,31 +133,31 @@
 	LIB_COMPATLINKS64=$SUNWUTLIB/compatlinks64
 	ETC_COMPATLINKS64=$SUNWUTETC/compatlinks64
 
-	LIBGDBM=/usr/lib/libgdbm.so.3
+	LIBGDBM=/usr/lib32/libgdbm.so.3
 	LIBGDBM64=/usr/lib64/libgdbm.so.3
-	COMPATLIB_LIBGDBM=/usr/lib/libgdbm.so.2
-	COMPATLIB_LIBGDBM64=/usr/lib64/libgdbm.so.2
+	COMPATLIB_LIBGDBM=/usr/lib32/libgdbm.so.2
+	COMPATLIB_LIBGDBM64=/usr/lib/x86_64-linux-gnu/libgdbm.so.3
 	COMPATLINK_LIBGDBM=$LIB_COMPATLINKS/${LIBGDBM##*/}
 	COMPATLINK64_LIBGDBM=$LIB_COMPATLINKS64/${LIBGDBM64##*/}
 
-	LIBLDAP=/usr/lib/libldap.so.199
+	LIBLDAP=/usr/lib32/libldap.so.199
 	LIBLDAP64=/usr/lib64/libldap.so.199
-	COMPATLIB_LIBLDAP=/usr/lib/libldap-2.3.so.0
-	COMPATLIB_LIBLDAP64=/usr/lib64/libldap-2.3.so.0
+	COMPATLIB_LIBLDAP=/usr/lib32/libldap-2.4.so.2
+	COMPATLIB_LIBLDAP64=/usr/lib64/libldap-2.4.so.2
 	COMPATLINK_LIBLDAP=$LIB_COMPATLINKS/${LIBLDAP##*/}
 	COMPATLINK64_LIBLDAP=$LIB_COMPATLINKS64/${LIBLDAP##*/}
 
-	LIBLBER=/usr/lib/liblber.so.199
+	LIBLBER=/usr/lib32/liblber.so.199
 	LIBLBER64=/usr/lib64/liblber.so.199
-	COMPATLIB_LIBLBER=/usr/lib/liblber-2.3.so.0
-	COMPATLIB_LIBLBER64=/usr/lib64/liblber-2.3.so.0
+	COMPATLIB_LIBLBER=/usr/lib32/liblber-2.4.so.2
+	COMPATLIB_LIBLBER64=/usr/lib64/liblber-2.4.so.2
 	COMPATLINK_LIBLBER=$LIB_COMPATLINKS/${LIBLBER##*/}
 	COMPATLINK64_LIBLBER=$LIB_COMPATLINKS64/${LIBLBER##*/}
 
  	LIBSSL=/usr/lib/libssl.so.0.9.7
  	LIBCRYPTO=/usr/lib/libcrypto.so.0.9.7
-	COMPATLIB_LIBSSL=/lib/libssl.so.0.9.8e
-	COMPATLIB_LIBCRYPTO=/lib/libcrypto.so.0.9.8e
+	COMPATLIB_LIBSSL=/lib32/libssl.so.0.9.8
+	COMPATLIB_LIBCRYPTO=/lib32/libcrypto.so.0.9.8
 }
 
 
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWut/lib/utctl.d/features/utcronctl /opt/SUNWut/lib/utctl.d/features/utcronctl
--- /opt.orig/SUNWut/lib/utctl.d/features/utcronctl	2011-06-04 00:27:47.000000000 +0200
+++ /opt/SUNWut/lib/utctl.d/features/utcronctl	2011-08-08 16:10:31.437863993 +0200
@@ -37,13 +37,13 @@
 		return
 	fi
 
-	(set +e; head -1 $CRONFILE | \
+	(set +e; head -n 1 $CRONFILE | \
 	    grep "^# DO NOT EDIT THIS FILE - edit the master and reinstall" \
 	    > /dev/null 2>&1)
 	if [ $? -eq 0 ]; then
 		# comment exists, remove them
 		cat /dev/null >$TMPFILE_COMM
-		head -3 $CRONFILE | sed \
+		head -n 3 $CRONFILE | sed \
 		-e "/^# DO NOT EDIT THIS FILE - edit the master and reinstall/d" \
 		-e "/^# (\/[^ ]* installed/d" \
 		-e "/^# (Cron version/d" >> $TMPFILE_COMM
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWut/lib/utctl.d/features/utgdmconfigctl /opt/SUNWut/lib/utctl.d/features/utgdmconfigctl
--- /opt.orig/SUNWut/lib/utctl.d/features/utgdmconfigctl	2011-06-04 00:27:47.000000000 +0200
+++ /opt/SUNWut/lib/utctl.d/features/utgdmconfigctl	2011-08-08 16:10:31.437863993 +0200
@@ -429,7 +429,7 @@
 		SRCRASHSCRIPT="${SUNRAY_GDM_DIR}/XKeepsCrashing.sunray"
 		GDM_PACKAGE_NAME="gdm"
 		TMPFILE="/var/opt/SUNWut/tmp/custom.conf.tmp.$$"
-		GDMGREETER=$(resolvePath gdmgreeter /usr/lib /usr/libexec)
+		GDMGREETER=$(resolvePath gdmgreeter /usr/lib /usr/libexec /usr/lib/gdm)
 		if [ $OS = "SunOS" ]; then
 			AWK=nawk
 		else
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWut/lib/utdmsession /opt/SUNWut/lib/utdmsession
--- /opt.orig/SUNWut/lib/utdmsession	2011-06-04 00:27:47.000000000 +0200
+++ /opt/SUNWut/lib/utdmsession	2011-08-08 16:10:31.437863993 +0200
@@ -26,7 +26,7 @@
 #exec >/var/tmp/utdmsession.$$ 2>&1       # Debug
 #set -x
 
-MOD="`/bin/basename $0`"
+MOD="`basename $0`"
 USAGE="usage: $MOD [-c|-d] Xdisplay [-z tag]"
 UTMNT_DIRLOCK=".session"
 
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWut/lib/utdtsession /opt/SUNWut/lib/utdtsession
--- /opt.orig/SUNWut/lib/utdtsession	2011-06-04 00:27:47.000000000 +0200
+++ /opt/SUNWut/lib/utdtsession	2011-08-08 16:10:31.437863993 +0200
@@ -623,7 +623,7 @@
 	# so that a new session can be created.
 
 	# get the existing session ID
-	oldsid=$(head -1 $tif)
+	oldsid=$(head -n 1 $tif)
 
 	# get the existing session type
 	OLD_SESSION_TYPE=""
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWut/lib/utgdmconfigpath /opt/SUNWut/lib/utgdmconfigpath
--- /opt.orig/SUNWut/lib/utgdmconfigpath	2011-06-04 00:27:47.000000000 +0200
+++ /opt/SUNWut/lib/utgdmconfigpath	2011-08-08 16:10:31.437863993 +0200
@@ -14,7 +14,7 @@
 if [ "`uname -s`" = "SunOS" ]; then
     gdm_path=`$UTWHICH -f $gdm_search_path custom.conf`
 else
-    gdm_path=`rpm -ql "gdm" | grep "custom.conf"`
+    gdm_path="/etc/gdm"
 fi
 
 if [ $? -ne 0 ]; then
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWut/lib/utgenpam /opt/SUNWut/lib/utgenpam
--- /opt.orig/SUNWut/lib/utgenpam	2011-04-23 07:52:10.000000000 +0200
+++ /opt/SUNWut/lib/utgenpam	2011-08-08 16:10:31.437863993 +0200
@@ -459,9 +459,9 @@
 LIB_SUNWUTO="$BASEDIR_O/SUNWut/lib"
 LIB_SUNWKIO="$BASEDIR_KIOSK/SUNWkio/lib"
 if [ $OS = "Linux" ]; then
-	LIB_SUNWUTPS="$ETCDIR_LIB/\$\PLATFORM"
-	LIB_SUNWUTGSM="$ETCDIR_LIB/\$\PLATFORM"
-	LIB_SUNWUTKIOSK="$ETCDIR_LIB/\$\PLATFORM"
+	LIB_SUNWUTPS="$ETCDIR_LIB/`uname -m`"
+	LIB_SUNWUTGSM="$ETCDIR_LIB/`uname -m`"
+	LIB_SUNWUTKIOSK="$ETCDIR_LIB/`uname -m`"
 else
 	LIB_SUNWUTPS="$BASEDIR_PS/SUNWut/lib"
 	LIB_SUNWUTGSM="$BASEDIR_GSM/SUNWut/lib"
@@ -492,7 +492,7 @@
 DTSESSION="dtsession-$SUNRAY_XSERVER_CLASS_TYPE"
 
 # GDM app name in pam.conf
-GDM="gdm"
+GDM="gdm-2.20"
 
 # GNOME application name in pam.conf
 XSCREENSAVER="xscreensaver"
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWut/lib/utpamcfg /opt/SUNWut/lib/utpamcfg
--- /opt.orig/SUNWut/lib/utpamcfg	2011-06-04 00:27:47.000000000 +0200
+++ /opt/SUNWut/lib/utpamcfg	2011-08-08 16:10:31.437863993 +0200
@@ -713,7 +713,7 @@
         if $isdir ; then
             #Update the config file with client_stack
             if [ "$attheend" == "FALSE" ] ; then
-		/bin/gawk -v cs="$client_stack" -v ct="$client_type" '
+		gawk -v cs="$client_stack" -v ct="$client_type" '
                 {
                     if (( $1 == ct) && ( count == 0 )) {
                         print cs;
@@ -727,7 +727,7 @@
                 }
                 ' $conffile >$tmpfile
             else
-		/bin/gawk -v cs="$client_stack" -v ct="$client_type" -v bt="$begin_tag" '
+		gawk -v cs="$client_stack" -v ct="$client_type" -v bt="$begin_tag" '
                 {
                     print $0;
                     if ( $0 == bt ) {
@@ -755,7 +755,7 @@
             return
         else
 	    if [ "$attheend" == "FALSE" ] ; then
-                /bin/gawk -v cs="$client_stack" -v ct="$client_type" -v c="$client" '
+                gawk -v cs="$client_stack" -v ct="$client_type" -v c="$client" '
                 {
                     if (( $1 == c ) && ( $2 == ct ) && ( count == 0 )) {
                         print cs ;
@@ -769,7 +769,7 @@
                 }
                 ' $conffile >$tmpfile
             else
-		/bin/gawk -v cs="$client_stack" -v ct="$client_type" -v c="$client" -v bt="$begin_tag" '
+		gawk -v cs="$client_stack" -v ct="$client_type" -v c="$client" -v bt="$begin_tag" '
                 {
                     print $0;
                     if ( $0 == bt ) {
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWut/lib/utprodinfo /opt/SUNWut/lib/utprodinfo
--- /opt.orig/SUNWut/lib/utprodinfo	2011-06-04 00:50:04.000000000 +0200
+++ /opt/SUNWut/lib/utprodinfo	2011-08-08 16:10:31.437863993 +0200
@@ -75,6 +75,8 @@
 set -A SunOS_Mapped_Sed
 # Mapped parameter query format for the Linux packaging utility
 set -A Linux_Mapped_Param
+# Mapped parameter query format for the dpkg packaging utility
+set -A Debian_Mapped_Param
 # Maximum number of parameters allowed
 typeset -i MAXParam=1
 
@@ -82,42 +84,50 @@
 Param[${MAXParam}]="BASEDIR"
 SunOS_Mapped_Param[${MAXParam}]="BASEDIR"
 Linux_Mapped_Param[${MAXParam}]="%{INSTALLPREFIX}"
+Debian_Mapped_Param[${MAXParam}]="INSTALLPREFIX"
 let MAXParam+=1
 # --- VERSION - version number with the build info.  Ex: 2.0_37.b
 Param[${MAXParam}]="VERSION"
 SunOS_Mapped_Param[${MAXParam}]="VERSION"
 SunOS_Mapped_Sed[${MAXParam}]="s/\([0-9][0-9]*\.[0-9][0-9]*_[0-9][0-9]*.*\),.*/\1/"
 Linux_Mapped_Param[${MAXParam}]="%{VERSION}_%{RELEASE}"
+Debian_Mapped_Param[${MAXParam}]="DEBVERSION"
 let MAXParam+=1
 # --- PSTAMP - product timestamp
 Param[${MAXParam}]="PSTAMP"
 SunOS_Mapped_Param[${MAXParam}]="PSTAMP"
 Linux_Mapped_Param[${MAXParam}]="%{BUILDTIME:date}"
+Debian_Mapped_Param[${MAXParam}]=""
 let MAXParam+=1
 # --- NAME - description of the package.
 Param[${MAXParam}]="NAME"
 SunOS_Mapped_Param[${MAXParam}]="NAME"
 Linux_Mapped_Param[${MAXParam}]="%{SUMMARY}"
+Debian_Mapped_Param[${MAXParam}]='${Description;40}'
 let MAXParam+=1
 # --- PRODVERS - product version without the build info.  Ex: 2.0
 Param[${MAXParam}]="PRODVERS"
 SunOS_Mapped_Param[${MAXParam}]="SUNW_PRODVERS"
 Linux_Mapped_Param[${MAXParam}]="%{VERSION}"
+Debian_Mapped_Param[${MAXParam}]="DEBPRODVERS"
 let MAXParam+=1
 # --- PKGNAME - package name. Ex: SUNWuto
 Param[${MAXParam}]="PKGNAME"
 SunOS_Mapped_Param[${MAXParam}]="PKGINST"
 Linux_Mapped_Param[${MAXParam}]="%{NAME}"
+Debian_Mapped_Param[${MAXParam}]='${Package}\\n'
 let MAXParam+=1
 # --- INSTDATE - date the package is installed on the system.
 Param[${MAXParam}]="INSTDATE"
 SunOS_Mapped_Param[${MAXParam}]="INSTDATE"
 Linux_Mapped_Param[${MAXParam}]="%{INSTALLTIME:date}"
+Debian_Mapped_Param[${MAXParam}]=""
 let MAXParam+=1
 # --- PATCHLIST - list of patches installed for this package.
 Param[${MAXParam}]="PATCHLIST"
 SunOS_Mapped_Param[${MAXParam}]="PATCHLIST"
 Linux_Mapped_Param[${MAXParam}]=""
+Debian_Mapped_Param[${MAXParam}]=""
 let MAXParam+=1
 
 
@@ -156,6 +166,14 @@
 			# add key name manipulation sed script
 			SEDLIST="${SEDLIST} -e s/^${SunOS_Mapped_Param[${1}]}=/${Param[${1}]}=/"
 		fi
+	elif [[ ${PREFIX} = "Debian" ]]; then
+		if [[ -n "${Debian_Mapped_Param[${1}]}" ]]; then
+			if ${2}; then
+				MAPPEDLIST="${MAPPEDLIST}${Param[${1}]}=${Debian_Mapped_Param[${1}]}"
+			else
+				MAPPEDLIST="${Debian_Mapped_Param[${1}]}"
+			fi
+		fi
 	else
 		if [[ -n "${Linux_Mapped_Param[${1}]}" ]]; then
 			if ${2}; then
@@ -323,6 +341,13 @@
 	return $?
 }
 
+function Debian_dispAll {
+	$DEBUG
+	# NOTE: must sort first so that we can return the exit code from grep
+	dpkg -l | grep "Sun Ray"
+	return $?
+}
+
 #
 # dispParams - displays the parameter information in key-value form.
 # $1 - package name
@@ -345,7 +370,43 @@
 	return 0
 }
 
+function Debian_dispParams {
+	$DEBUG
+	if ! ${PREFIX}_testPkg installed $PKGNAME; then
+		# package not installed;
+		print -u2 "${ERROR_PREF} package $PKGNAME not installed"
+		return 1
+	fi
+
+	buildParamList "$@"
+	if [[ $? -eq 1 ]]; then
+		# found no params, just return
+		return 0
+	fi
+
+	# This is becaue the alien converted packaged are lowercase
+	DEB="`echo "${PKGNAME}" | tr '[A-Z]' '[a-z]'`"
+	VERSION=""
+	PRODVERS=""
+
+	# The below is a bit of a hack to get the correct informtin out of dpkg-query
+	# it always returns /opt as the basedir
 
+	if [ "`echo "${MAPPEDLIST}"|grep "DEBVERSION"`" ]; then
+		VERSION="`dpkg-query -f '${Version}\n' -W "${DEB}" | sed -e 's/-/_/'`"
+	fi
+	if [ "`echo "${MAPPEDLIST}"|grep "DEBPRODVERS"`" ]; then
+		PRODVERS="`dpkg-query -f '${Version}\n' -W "${DEB}" | sed -e 's/-.*$//'`"
+	fi
+
+	QL="`echo "${MAPPEDLIST}"|sed -e 's/INSTALLPREFIX/\/opt/g' -e "s/DEBVERSION/${VERSION}/g" -e "s/DEBPRODVERS/${PRODVERS}/g"`"
+	if [ "`echo "${QL}"|grep '\\$'`" ]; then
+		dpkg-query -f "${QL}" -W "${DEB}"
+	else
+		echo "${QL}"
+	fi
+	return 0
+}
 #
 # testPkg - test the condition specified on the package.
 # $1 - test condition
@@ -377,6 +438,33 @@
 	return 1
 }
 
+function Debian_testPkg {
+	$DEBUG
+	if [[ $# -ne 2 ]]; then
+		return 1
+	fi
+	DEB="`echo "$2" | tr '[A-Z]' '[a-z]'`"
+	case $1 in
+	"installed")	# package installed, could be either partial or complete
+		dpkg-query -W $DEB > /dev/null 2>&1
+		return $?;;
+	"partial")	# package partially installed
+		#
+		# rpm does not understand the concept of partially installed packages.
+		# So, for now, we always return 1 (ie. false) since it can never be
+		# partially installed packages.
+		#
+		return 1;;
+	"complete")	# package completely installed
+		# dpkg format does not have a verify option, this will return if installed even partially
+		dpkg-query -q $DEB > /dev/null 2>&1
+		return $?;;
+	esac
+
+	# invalid test condition
+	print -u2 "${ERROR_PREF} invalid test operation \"$1\"."
+	return 1
+}
 
 PREFIX=`uname -s`
 if [[ -z "$PREFIX" ]]; then
@@ -385,6 +473,13 @@
 	exit 1
 fi
 
+if [[ "$PREFIX" = "Linux" ]]; then
+	. /etc/lsb-release
+	if [[ "$DISTRIB_ID" = "Ubuntu" ]] || [[ "$DISTRIB_ID" = "Debian" ]]; then
+		PREFIX="Debian"
+	fi
+fi
+
 OPMODE=""
 SUBOP=""
 PKGNAME=""
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWut/lib/utpulse.pa /opt/SUNWut/lib/utpulse.pa
--- /opt.orig/SUNWut/lib/utpulse.pa	1970-01-01 01:00:00.000000000 +0100
+++ /opt/SUNWut/lib/utpulse.pa	2011-08-08 16:10:31.437863993 +0200
@@ -0,0 +1,2 @@
+load-module module-oss device=UTAUDIODEV playback=1 record=0 fragment_size=8192
+load-module module-native-protocol-unix
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWut/lib/utwebadmin /opt/SUNWut/lib/utwebadmin
--- /opt.orig/SUNWut/lib/utwebadmin	2011-04-23 07:55:25.000000000 +0200
+++ /opt/SUNWut/lib/utwebadmin	2011-08-08 16:10:31.437863993 +0200
@@ -91,7 +91,7 @@
     if [ ! -n "$rootShell" ]; then
         rootShell=/bin/sh
     fi
-    for shell in `cat /etc/shells`
+    for shell in `egrep -v '^#' /etc/shells`
     do
         if [ $shell != $rootShell ]; then
             SU_SHELL="-s $shell"
@@ -804,7 +804,7 @@
     # directory.  So let's try a simple test to see if we can at least
     # assume that user's identity.
     #
-    su ${SU_SHELL} ${PROCESS_USERNAME} -c "pwd >/dev/null 2>&1" >/dev/null 2>&1
+    su ${SU_SHELL} ${PROCESS_USERNAME} -c "pwd" >/dev/null 2>&1
     if [ $? -ne 0 ]; then
         logError "Startup failed: unable to become the user identity \"${PROCESS_USERNAME}\"."
         logError "This may be due to one of the following:"
@@ -822,7 +822,7 @@
     # exitting fatally if we don't.
     #
     touchFile=`dirname $TMP_SH`/tiptoe.$$
-    su ${SU_SHELL} ${PROCESS_USERNAME} -c "$ECHO \"\" > $touchFile 2>&1" >/dev/null 2>&1
+    su ${SU_SHELL} ${PROCESS_USERNAME} -c "$ECHO \"\" > $touchFile" >/dev/null 2>&1
     if [ $? -ne 0 ]; then
         logError "Startup failed: the user identity \"${PROCESS_USERNAME}\""
         logError "does not have permissions to write to the directory `dirname $TMP_SH`."
@@ -832,7 +832,7 @@
     rm -f $touchFile
 
     logDebug "Executing startup script ${TMP_SH} with user identity ${PROCESS_USERNAME}."
-    su ${SU_SHELL} ${PROCESS_USERNAME} -c "nohup ${TMP_SH} >/dev/null 2>&1"
+    su ${SU_SHELL} ${PROCESS_USERNAME} -c "nohup ${TMP_SH}" >/dev/null 2>&1
 
     else
         logError "Startup failed: invalid launch command - ${LAUNCH_COMMAND}"
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWut/lib/utxinit /opt/SUNWut/lib/utxinit
--- /opt.orig/SUNWut/lib/utxinit	2011-06-04 00:27:48.000000000 +0200
+++ /opt/SUNWut/lib/utxinit	2011-08-08 16:10:31.437863993 +0200
@@ -102,7 +102,7 @@
 	XSERVER="/bin/false"
 	# we check for Xnewt first.  It will only fall back to Xsun if
 	# Xnewt does not exist.
-	for XSERVERBIN in /usr/X11R6/bin/Xnewt /usr/openwin/bin/Xsun ; do
+	for XSERVERBIN in /opt/SUNWut/lib/Xnewt /usr/openwin/bin/Xsun ; do
 		if [ -x $XSERVERBIN ] ; then
 			XSERVER=$XSERVERBIN
 			break
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWut/lib/xmgr/gdm/add-dpy /opt/SUNWut/lib/xmgr/gdm/add-dpy
--- /opt.orig/SUNWut/lib/xmgr/gdm/add-dpy	2011-06-04 00:27:47.000000000 +0200
+++ /opt/SUNWut/lib/xmgr/gdm/add-dpy	2011-08-08 16:10:31.437863993 +0200
@@ -64,7 +64,7 @@
 xcdesc="DisplayManager.*_%d.environment: SUN_SUNRAY_TOKEN=$token CORONA_TOKEN=$token"
 if [ "$type" = normal ]
 then
-	xsdesc=":%d SunRay local /usr/X11R6/bin/Xnewt :%d"
+	xsdesc=":%d SunRay local /opt/SUNWut/lib/Xnewt :%d"
 else
 	xsdesc="# :%d RESERVED"
 fi
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWut/lib/xmgr/gdm/notify /opt/SUNWut/lib/xmgr/gdm/notify
--- /opt.orig/SUNWut/lib/xmgr/gdm/notify	2011-06-04 00:27:47.000000000 +0200
+++ /opt/SUNWut/lib/xmgr/gdm/notify	2011-08-08 16:10:31.437863993 +0200
@@ -22,16 +22,7 @@
 
 verbose=0
 umask 0022
-DMNAME=gdm-binary
-which_gdm=$(whence gdm-binary)
-if [ -z $which_gdm ]; then
-	which_gdm=$(whence gdm)
-	if [ -z $which_gdm ]; then
-		print -u2 "gdm/gdm-binary not found"
-		exit 1
-	fi
-	DMNAME=gdm
-fi
+DMNAME=gdm
 unset LD_LIBRARY_PATH
 BASE=/etc/opt/SUNWut/basedir
 SUNWUTLIB=$BASE/lib
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWut/lib/xmgr/gdm/remove-dpy /opt/SUNWut/lib/xmgr/gdm/remove-dpy
--- /opt.orig/SUNWut/lib/xmgr/gdm/remove-dpy	2011-06-04 00:27:47.000000000 +0200
+++ /opt/SUNWut/lib/xmgr/gdm/remove-dpy	2011-08-08 16:10:31.437863993 +0200
@@ -40,7 +40,7 @@
 POSTSESSION_DIR=${GDM_DIR}PostSession
 INIT_DIR=${GDM_DIR}Init
 
-DPY=`/bin/gawk -F= '{
+DPY=`/usr/bin/gawk -F= '{
 	if ($1 == "DISPLAY") {print $2} 
 	}' /tmp/SUNWut/config/ctokens/$token`
 
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWut/lib/xmgr/gdm/reset-dpy /opt/SUNWut/lib/xmgr/gdm/reset-dpy
--- /opt.orig/SUNWut/lib/xmgr/gdm/reset-dpy	2011-06-04 00:27:47.000000000 +0200
+++ /opt/SUNWut/lib/xmgr/gdm/reset-dpy	2011-08-08 16:12:12.628193191 +0200
@@ -1,4 +1,4 @@
-#!/bin/sh
+#!/bin/ksh -p
 #
 # ident "@(#)gdm-reset-dpy.sh	1.11	11/01/26 Oracle"
 #
@@ -18,16 +18,7 @@
 
 CONFIGDIR=$1
 CONFIGXDIR=$CONFIGDIR/xconfig
-DMNAME=gdm-binary
-which_gdm=$($UTWHICH gdm-binary)
-if [ -z $which_gdm ]; then
-        which_gdm=$($UTWHICH gdm)
-        if [ -z $which_gdm ]; then
-                echo "gdm/gdm-binary not found" 1>&2
-                exit 1
-        fi
-	DMNAME=gdm
-fi
+DMNAME=gdm
 
 # Note - we start MINDISP at 11 using gdm for linux. It gets around bug
 # 5057552, which is actually caused by lax privileges defined by 
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWut/sbin/utadm /opt/SUNWut/sbin/utadm
--- /opt.orig/SUNWut/sbin/utadm	2011-06-04 00:27:48.000000000 +0200
+++ /opt/SUNWut/sbin/utadm	2011-08-08 16:10:31.447864025 +0200
@@ -228,13 +228,24 @@
 		else
 		  NETWORKS="${ETC_OPT_UT}/net/networks";
 		fi
-		DHCPCONFIG="/etc/dhcpd.conf"
+		if [[ -f "/etc/dhcp/dhcpd.conf" ]]; then
+		  DHCPCONFIG="/etc/dhcp/dhcpd.conf"
+		else
+		  DHCPCONFIG="/etc/dhcpd.conf"
+		fi
 		GREP=grep	# XXX need to figure out which <===
-		INIT_DHCP="/etc/init.d/dhcpd";
+		if [[ -f "/etc/init.d/isc-dhcp-server" ]]; then
+		  INIT_DHCP="/etc/init.d/isc-dhcp-server"
+		else
+		  INIT_DHCP="/etc/init.d/dhcpd";
+		fi
 		if [[ -d "/etc/sysconfig/network-scripts" ]] ; then
 		  IFCONFIG_SCRIPT="/etc/sysconfig/network-scripts/ifcfg-"
 		  IFCONFIG_BOOT="ONBOOT=yes"
 		  BOOTPROTO=none
+		elif [[ -f "/etc/network/interfaces" ]] ; then
+		  IFCONFIG_SCRIPT="/etc/network/interfaces"
+		  BOOTPROTO=static
 		else
 		  IFCONFIG_SCRIPT="/etc/sysconfig/network/ifcfg-"
 		  IFCONFIG_BOOT="STARTMODE=onboot"
@@ -1003,6 +1014,10 @@
   # get the intf's symbolic name
   INTF_NAME=`getent hosts ${INTF_IPA} | awk '{print $2}'`;
   if [ -z "${INTF_NAME}" ]; then
+    # Work around for bug in Ubuntu getent Launchpad BugID 28585
+    INTF_NAME=`getent hosts | grep -w ${INTF_IPA} | awk '{print $2}'`
+  fi
+  if [ -z "${INTF_NAME}" ]; then
     print -u2 "Error: host name for ${INTF_IPA} not found"
     exit 1;
   fi
@@ -1157,8 +1172,40 @@
     ifconfig ${INTF} "${IPADDR}" up netmask "${NETMASK}" broadcast ${BROADCAST};
     RC=$?
     if [[ ${RC} -eq 0 ]] ; then
-      rm -f ${TMPDIR}/tmpfile.$$;
-      cat > ${TMPDIR}/tmpfile.$$ <<-!
+      . /etc/lsb-release 2 > /dev/null
+      if [[ "$DISTRIB_ID" = "Ubuntu" ]] || [[ "$DISTRIB_ID" = "Debian" ]]; then
+        rm -f ${TMPDIR}/tmpfile.$$;
+        cat > ${TMPDIR}/tmpfile.$$ <<-!
+# SUNRAY ADD
+auto ${INTF}
+iface ${INTF} inet ${BOOTPROTO}
+address ${IPADDR}
+netmask ${NETMASK}
+# SUNRAY ADD
+!
+        awk ' {
+          if (NF == "0") print $0;
+          else if ($1 == "allow") {print $0; param="false";}
+          else if ($1 == "mapping") {print $0; param="false";}
+          else if ($1 == "auto")
+            {if ($2 == Intf) print "# SUNRAY DEL "$0;
+             else print $0;
+             param="false";}
+          else if ($1 == "iface")
+            {if ($2 == Intf) {print "# SUNRAY DEL "$0; param="true";}
+             else {print $0; param="false";}}
+          else if (param == "true") print "# SUNRAY DEL "$0;
+          else {print $0; param="false";}
+          }' \
+          Intf=${INTF} \
+          ${IFCONFIG_SCRIPT} > ${IFCONFIG_SCRIPT}.$$
+
+        cat ${IFCONFIG_SCRIPT}.$$ ${TMPDIR}/tmpfile.$$ > ${IFCONFIG_SCRIPT}
+        rm -f ${TMPDIR}/tmpfile.$$ ${IFCONFIG_SCRIPT}.$$
+
+      else
+        rm -f ${TMPDIR}/tmpfile.$$;
+        cat > ${TMPDIR}/tmpfile.$$ <<-!
 DEVICE=${INTF} # SUNRAY ADD 
 USERCTL=no # SUNRAY ADD 
 ${IFCONFIG_BOOT} # SUNRAY ADD 
@@ -1168,16 +1215,17 @@
 NETMASK=${NETMASK} # SUNRAY ADD
 IPADDR=${IPADDR} # SUNRAY ADD
 !
-      if [[ -f ${IFCONFIG_SCRIPT}${INTF} ]] ; then
-	sed -e "/^"HWADDR"/!s/^/# SUNRAY DEL /" "${IFCONFIG_SCRIPT}${INTF}" > ${IFCONFIG_SCRIPT}${INTF}.$$
-        #
-        # change ether config so it starts on boot
-	
-	rm -f ${IFCONFIG_SCRIPT}${INTF}
-	cat ${IFCONFIG_SCRIPT}${INTF}.$$ ${TMPDIR}/tmpfile.$$ > ${IFCONFIG_SCRIPT}${INTF}
-	rm -f ${IFCONFIG_SCRIPT}${INTF}.$$ ${TMPDIR}/tmpfile.$$
-      else
-        mv -f ${TMPDIR}/tmpfile.$$ ${IFCONFIG_SCRIPT}${INTF};
+        if [[ -f ${IFCONFIG_SCRIPT}${INTF} ]] ; then
+          sed -e "/.*/s/^/# SUNRAY DEL /" "${IFCONFIG_SCRIPT}${INTF}" > ${IFCONFIG_SCRIPT}${INTF}.$$
+          #
+          # change ether config so it starts on boot
+   
+          rm -f ${IFCONFIG_SCRIPT}${INTF}
+          cat ${IFCONFIG_SCRIPT}${INTF}.$$ ${TMPDIR}/tmpfile.$$ > ${IFCONFIG_SCRIPT}${INTF}
+          rm -f ${IFCONFIG_SCRIPT}${INTF}.$$ ${TMPDIR}/tmpfile.$$
+        else
+          mv -f ${TMPDIR}/tmpfile.$$ ${IFCONFIG_SCRIPT}${INTF};
+        fi
       fi
     fi
     print "### finished install of \"${INTF}\" interface";
@@ -1199,6 +1247,38 @@
       if [[ ! -s ${IFCONFIG_SCRIPT}${INTF} ]]; then
 	rm -f ${IFCONFIG_SCRIPT}${INTF}
       fi
+    elif [[ -f ${IFCONFIG_SCRIPT} ]] ; then
+      cp ${IFCONFIG_SCRIPT} ${IFCONFIG_SCRIPT}.$$
+      awk ' {
+       if (($2 == "SUNRAY" ) && ($3 == "DEL"))
+         {if (($4 == "auto") && ($5 == Intf))
+            {output="";
+             for (field=4; field<=NF; ++field) {output=output$field" ";} 
+             print output;
+             param="false";}
+          else if (($4 == "iface") && ($5 == Intf ))
+            {output=""; for (field=4; field<=NF; ++field) {output=output$field" ";}
+             print output;
+             param="true";}
+          else if (param == "true")
+            {output=""; for (field=4; field<=NF; ++field) {output=output$field" ";}
+             print output;
+             param="true";}
+          else {print $0; param="false";}
+         }
+       else if (($2 == "SUNRAY") && ($3 == "ADD"))
+         {if (comment_count == "1") {if (remove != "true") {print $0;};comment_count = "2";remove = "false";}
+          else if (comment_count == "2") {comment_count = "1";remove = "possible"}
+          else {comment_count = "1"; remove="possible";}
+         }
+       else if (remove == "possible")
+         if (($1 == "auto") && ($2 == Intf)) {remove="true";}
+         else {remove="false";print "# SUNRAY ADD"; print $0;}
+       else if (remove != "true") {print $0; param="false";}
+      }' \
+      Intf=${INTF} \
+      ${IFCONFIG_SCRIPT}.$$ > ${IFCONFIG_SCRIPT}
+      rm -f ${IFCONFIG_SCRIPT}.$$
     else
       print -u2 "Warning: unable to update ${IFCONFIG_SCRIPT}${INTF}";
     fi
@@ -3311,6 +3391,8 @@
 		lease_file=/var/lib/dhcpd/dhcpd.leases
 	elif [ -f /var/lib/dhcp/db/dhcpd.leases ]; then
                 lease_file=/var/lib/dhcp/db/dhcpd.leases
+	elif [ -f /var/lib/dhcp/dhcpd.leases ]; then
+                lease_file=/var/lib/dhcp/dhcpd.leases
         fi
 
 	rm -f $tmp_leases
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWut/sbin/utatiscrub /opt/SUNWut/sbin/utatiscrub
--- /opt.orig/SUNWut/sbin/utatiscrub	2011-06-04 00:27:48.000000000 +0200
+++ /opt/SUNWut/sbin/utatiscrub	2011-08-08 16:10:31.447864025 +0200
@@ -16,7 +16,7 @@
 
 selectImportedTokens() {
 	${UTUSER} -xo \
-		| /bin/gawk -F, '$1 ~ "user\\.IMPORTED-.*" \
+		| gawk -F, '$1 ~ "user\\.IMPORTED-.*" \
 		 { print $2 }'
 }
 
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWut/sbin/utconfig /opt/SUNWut/sbin/utconfig
--- /opt.orig/SUNWut/sbin/utconfig	2011-06-04 00:27:48.000000000 +0200
+++ /opt/SUNWut/sbin/utconfig	2011-08-08 16:10:31.447864025 +0200
@@ -257,7 +257,12 @@
     # Define Linux specific LDAP variables
     # Determine which LDAP client package is installed
     #
-    LCL_PACKAGE="$(rpm -qf /usr/bin/ldapadd 2>/dev/null)"
+    . /etc/lsb-release
+    if [[ "$DISTRIB_ID" = "Ubuntu" ]] || [[ "$DISTRIB_ID" = "Debian" ]]; then
+      LCL_PACKAGE="$(dpkg-query -S /usr/bin/ldapadd | awk -F: '{print $1}' 2>/dev/null)"
+    else
+      LCL_PACKAGE="$(rpm -qf /usr/bin/ldapadd 2>/dev/null)"
+    fi
 
     # Define Linux versions of LDAP client commands
     #
@@ -272,7 +277,11 @@
     # Define Linux specific filenames
     #
     ETCSERVICES="/etc/services"
-    DHCPCONFIG="/etc/dhcpd.conf"
+    if [[ -f "/etc/dhcp/dhcpd.conf" ]]; then
+      DHCPCONFIG="/etc/dhcp/dhcpd.conf"
+    else
+      DHCPCONFIG="/etc/dhcpd.conf"
+    fi
     ;;
 
   *)
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWut/sbin/utfwadm /opt/SUNWut/sbin/utfwadm
--- /opt.orig/SUNWut/sbin/utfwadm	2011-06-04 00:27:48.000000000 +0200
+++ /opt/SUNWut/sbin/utfwadm	2011-08-08 16:10:31.447864025 +0200
@@ -182,7 +182,7 @@
 function GetVersion  {
     FW_FILE_INPUT=${1}
     # extract the version string and make file names
-    FW_TYPE=$(od -t x1 $FW_FILE_INPUT | head -1 | awk '{ print sprintf("%s%s%s%s", $2,$3,$4,$5)}') 2> /dev/null
+    FW_TYPE=$(od -t x1 $FW_FILE_INPUT | head -n 1 | awk '{ print sprintf("%s%s%s%s", $2,$3,$4,$5)}') 2> /dev/null
     case $FW_TYPE in
 	4badbeef | 8badbeef | bbadbeef)	
             $UTWHAT $FW_FILE_INPUT > ${TMPDIR}/fw_strings.$$
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWut/sbin/utreplica /opt/SUNWut/sbin/utreplica
--- /opt.orig/SUNWut/sbin/utreplica	2011-06-04 00:27:48.000000000 +0200
+++ /opt/SUNWut/sbin/utreplica	2011-08-08 16:10:31.447864025 +0200
@@ -83,7 +83,12 @@
                         ETCSERVICES=/etc/inet/services
 			LOGFILE="/var/adm/log/$PROGRAM_ID.${TIMESTAMP}.log"
                         ;;
-                Linux)  LCL_PACKAGE="$(rpm -qf /usr/bin/ldapadd 2>/dev/null)"
+                Linux)  . /etc/lsb-release
+                        if [[ "$DISTRIB_ID" = "Ubuntu" ]] || [[ "$DISTRIB_ID" = "Debian" ]]; then
+                          LCL_PACKAGE="$(dpkg-query -S /usr/bin/ldapadd | awk -F: '{print $1}' 2>/dev/null)"
+                        else
+                          LCL_PACKAGE="$(rpm -qf /usr/bin/ldapadd 2>/dev/null)"
+                        fi
                         LDAPSEARCH="/usr/bin/ldapsearch -x -LLL "
 			GREP=/bin/grep
                         ETCSERVICES=/etc/services
@@ -1140,7 +1145,7 @@
 		    Fatal "$server is already configured as a primary server."
 		elif print $remote_rep | egrep "$SECONDARY_ID"\
 			>/dev/null 2>&1; then
-		    typeset -l tmp_host=`print "$remote_rep" | tail -1`
+		    typeset -l tmp_host=`print "$remote_rep" | tail -n 1`
 		    if [ "${tmp_host}" != $HOSTNAME ]; then
 		    	Fatal "$server is already configured as a secondary server\n"\
 			   "with a different primary."
@@ -1181,7 +1186,7 @@
   then
 	# only check the first line of the file.  This avoids the problem of accidentally
 	# picking up the "replica" attribute which will also have the same string match.
-  	head -1 $DSSERV_REPLOG | grep '^replica: ' >/dev/null 2>&1
+  	head -n 1 $DSSERV_REPLOG | grep '^replica: ' >/dev/null 2>&1
   	if [ $? -ne 0 ]
 	then
 		cat /dev/null > $DSSERV_REPLOG
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWut/sbin/utusbadm /opt/SUNWut/sbin/utusbadm
--- /opt.orig/SUNWut/sbin/utusbadm	2011-06-04 00:27:48.000000000 +0200
+++ /opt/SUNWut/sbin/utusbadm	2011-08-08 16:11:19.208017887 +0200
@@ -1,4 +1,3 @@
-#!/bin/sh
 #!/bin/ksh -p
 #
 # ident "@(#)utusbadm.ksh	1.9	11/01/20 Oracle"
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWutref/amgh/utamghref_allkeys_script /opt/SUNWutref/amgh/utamghref_allkeys_script
--- /opt.orig/SUNWutref/amgh/utamghref_allkeys_script	2011-04-23 07:52:14.000000000 +0200
+++ /opt/SUNWutref/amgh/utamghref_allkeys_script	2011-08-08 16:10:31.447864025 +0200
@@ -21,7 +21,7 @@
     then
         sed -n "s/^${key}=${value}[ 	].*\(${return_key}=[^	 ]*\).*/\1/p" $DBFILE
     else
-        sed -n "s/^${key}=${value}[ 	].*\(${return_key}=[^	 ]*\).*/\1/p" $DBFILE | tail -1
+        sed -n "s/^${key}=${value}[ 	].*\(${return_key}=[^	 ]*\).*/\1/p" $DBFILE | tail -n 1
     fi
 }
 
diff -r -u -N -X /tmp/exclude /opt.orig/SUNWutref/amgh/utamghref_script /opt/SUNWutref/amgh/utamghref_script
--- /opt.orig/SUNWutref/amgh/utamghref_script	2011-04-23 07:52:14.000000000 +0200
+++ /opt/SUNWutref/amgh/utamghref_script	2011-08-08 16:10:31.447864025 +0200
@@ -21,7 +21,7 @@
     then
         sed -n "s/^${key}=${value}[ 	].*\(${return_key}=[^	 ]*\).*/\1/p" $DBFILE
     else
-        sed -n "s/^${key}=${value}[ 	].*\(${return_key}=[^	 ]*\).*/\1/p" $DBFILE | tail -1
+        sed -n "s/^${key}=${value}[ 	].*\(${return_key}=[^	 ]*\).*/\1/p" $DBFILE | tail -n 1
     fi
 }
 
diff -r -u -N -X /tmp/exclude /etc/opt.orig/SUNWut/X11/fontpath /etc/opt/SUNWut/X11/fontpath
--- /etc/opt.orig/SUNWut/X11/fontpath	1970-01-01 01:00:00.000000000 +0100
+++ /etc/opt/SUNWut/X11/fontpath	2011-08-08 16:10:31.447864025 +0200
@@ -0,0 +1,8 @@
+/usr/share/fonts/X11/misc
+/usr/share/fonts/X11/cyrillic
+/usr/share/fonts/X11/100dpi/:unscaled
+/usr/share/fonts/X11/75dpi/:unscaled
+/usr/share/fonts/X11/Type1
+/usr/share/fonts/X11/100dpi
+/usr/share/fonts/X11/75dpi
+/var/lib/defoma/x-ttcidfont-conf.d/dirs/TrueType
diff -r -u -N -X /tmp/exclude /etc/opt.orig/SUNWut/gdm/SunRayInit/Default /etc/opt/SUNWut/gdm/SunRayInit/Default
--- /etc/opt.orig/SUNWut/gdm/SunRayInit/Default	2011-04-23 07:51:32.000000000 +0200
+++ /etc/opt/SUNWut/gdm/SunRayInit/Default	2011-08-08 16:10:31.447864025 +0200
@@ -14,7 +14,7 @@
 for i in /etc/opt/SUNWut/gdm/SunRayInit/helpers/*
 do
 	if [ -x $i ]; then
-	    . $i
+	    $i
 	fi
 done
 
diff -r -u -N -X /tmp/exclude /etc/opt.orig/SUNWut/gdm/SunRayPostSession/Default /etc/opt/SUNWut/gdm/SunRayPostSession/Default
--- /etc/opt.orig/SUNWut/gdm/SunRayPostSession/Default	2011-04-23 07:51:32.000000000 +0200
+++ /etc/opt/SUNWut/gdm/SunRayPostSession/Default	2011-08-08 16:10:31.447864025 +0200
@@ -11,7 +11,7 @@
 for i in /etc/opt/SUNWut/gdm/SunRayPostSession/helpers/*
 do
 	if [ -x $i ]; then
-	    . $i
+	    $i
 	fi
 done
 exit 0
diff -r -u -N -X /tmp/exclude /etc/opt.orig/SUNWut/gdm/SunRayPreSession/Default /etc/opt/SUNWut/gdm/SunRayPreSession/Default
--- /etc/opt.orig/SUNWut/gdm/SunRayPreSession/Default	2011-04-23 07:51:32.000000000 +0200
+++ /etc/opt/SUNWut/gdm/SunRayPreSession/Default	2011-08-08 16:10:31.447864025 +0200
@@ -18,7 +18,7 @@
 for i in /etc/opt/SUNWut/gdm/SunRayPreSession/helpers/*
 do
 	if [ -x $i ]; then
-	    . $i
+	    $i
 	fi
 done
 
diff -r -u -N -X /tmp/exclude /etc/opt.orig/SUNWut/gdm/XKeepsCrashing.sunray /etc/opt/SUNWut/gdm/XKeepsCrashing.sunray
--- /etc/opt.orig/SUNWut/gdm/XKeepsCrashing.sunray	2011-04-23 07:51:32.000000000 +0200
+++ /etc/opt/SUNWut/gdm/XKeepsCrashing.sunray	2011-08-08 16:10:31.447864025 +0200
@@ -28,19 +28,19 @@
 	grep "^:$DPY " $XCONFBASE/Xservers >/dev/null
 }
 
-if isSRSSDisplay; then
+#if isSRSSDisplay; then
 	logger -p user.error -t XKeepsCrashing.sunray "GDM can't start X server."
-else
-	typeset SYSTEM_KC=$GDMBASE/XKeepsCrashing
-	if [ -x "$SYSTEM_KC" ]; then
-		exec "$SYSTEM_KC"
-	else
-		logger -p user.error -t XKeepsCrashing.sunray \
-			"Can't find system XKeepsCrashing file '$SYSTEM_KC'"
-		# mark the display as unusable with exit 1
-		exit 1
-	fi
-fi
+#else
+#	typeset SYSTEM_KC=$GDMBASE/XKeepsCrashing
+#	if [ -x "$SYSTEM_KC" ]; then
+#		exec "$SYSTEM_KC"
+#	else
+#		logger -p user.error -t XKeepsCrashing.sunray \
+#			"Can't find system XKeepsCrashing file '$SYSTEM_KC'"
+#		# mark the display as unusable with exit 1
+#		exit 1
+#	fi
+#fi
 
 sleep 1
 # keep retrying display with exit 0
diff -r -u -N -X /tmp/exclude /etc/opt.orig/SUNWut/xinitrc.d/0100.SUNWut /etc/opt/SUNWut/xinitrc.d/0100.SUNWut
--- /etc/opt.orig/SUNWut/xinitrc.d/0100.SUNWut	2011-04-23 07:51:32.000000000 +0200
+++ /etc/opt/SUNWut/xinitrc.d/0100.SUNWut	2011-08-10 10:02:42.873633056 +0200
@@ -31,7 +31,7 @@
 }
 
 is_gnome_screensaver_used() {
-	[[ $OS == "Linux" && -n "$(utwhence gnome-screensaver-command $LPATH)" ]]
+	[ "$OS" = "Linux" ] && [ -n "$(utwhence gnome-screensaver-command $LPATH)" ]
 }
 
 #
@@ -69,7 +69,7 @@
 			# Set the LD_PRELOAD variable for Linux
 
 			OS=`/bin/uname -s`
-			if [[ $OS == "Linux" ]]; then
+			if [ "$OS" = "Linux" ]; then
 				# replicate custom and default code
 				# from /etc/X11/gdm/Xsession
 				# BEFORE we modify command
@@ -97,7 +97,7 @@
 
 				plat_libcut=`/bin/ls -1d /etc/opt/SUNWut/lib/*/libc_ut.so 2>/dev/null | /usr/bin/head -1`
 				if [ -n "$plat_libcut" -a -L "$plat_libcut" ]; then
-				    LD_PRELOAD=/etc/opt/SUNWut/lib/\$PLATFORM/libc_ut.so
+				    LD_PRELOAD=/etc/opt/SUNWut/lib/`uname -m`/libc_ut.so
 				else
 				    LD_PRELOAD=libc_ut.so
 				fi
@@ -157,10 +157,10 @@
 	# Start up the GUI for displaying current screen within a Multihead session
 	# It will simply exit if this is not a Multihead session
 	#
-	if [ -x $ADMIN_LIB/utmhscreen ]
-	then
-		$ADMIN_LIB/utmhscreen -l >/dev/null 2>&1 &
-	fi
+	#if [ -x $ADMIN_LIB/utmhscreen ]
+	#then
+	#	$ADMIN_LIB/utmhscreen -l >/dev/null 2>&1 &
+	#fi
 
 	# 
 	# Default desktop screen saver action list; anything but blank
@@ -201,17 +201,17 @@
 	else
 		# This is an authenticated session
 	        # If we need to use gnome-screensaver, set up DBUS environment for it
-	     	if is_gnome_screensaver_used; then
-			DBUSLAUNCH=$(utwhence dbus-launch $LPATH)
+	     	#if is_gnome_screensaver_used; then
+		#	DBUSLAUNCH=$(utwhence dbus-launch $LPATH)
 
-			# utxlock/utxunlock need dbus available, so they can reach 
-			# gnome-screensaver
-			if [ -x "$DBUSLAUNCH" -a -z "$DBUS_SESSION_BUS_ADDRESS" ] 
-			then
-				eval `$DBUSLAUNCH --exit-with-session --sh-syntax`
-			fi
-			unset DBUSLAUNCH
-		fi	
+		#	# utxlock/utxunlock need dbus available, so they can reach 
+		#	# gnome-screensaver
+		#	if [ -x "$DBUSLAUNCH" -a -z "$DBUS_SESSION_BUS_ADDRESS" ] 
+		#	then
+		#		eval `$DBUSLAUNCH --exit-with-session --sh-syntax`
+		#	fi
+		#	unset DBUSLAUNCH
+		#fi	
 
 		# Suppress utxlock, if pam_sunray might be causing the
 		# disconnect to prevent sceen-locking loop with
@@ -222,17 +222,17 @@
 		#    within utxlock)
 		
 		# If this is NSCM, $SUN_SUNRAY_UTXLOCK_PREF is set to NULL.
-		if $ADMIN_SBIN/utpolicy | /bin/grep -- -D >/dev/null \
-			&& [[ $SUN_SUNRAY_TOKEN != auth.* \
-			&& -n "${SUN_SUNRAY_UTXLOCK_PREF-foo}" ]]
-		then
+		#if $ADMIN_SBIN/utpolicy | /bin/grep -- -D >/dev/null \
+		#	&& [[ $SUN_SUNRAY_TOKEN != auth.* \
+		#	&& -n "${SUN_SUNRAY_UTXLOCK_PREF-foo}" ]]
+		#then
 			$ADMIN_BIN/utaction -i -d $ADMIN_BIN/utxlock &
-		fi
+		#fi
 
 		# For non-kiosk sessions we do the opposite to cope with (Linux) 
 		# screensavers that don't play with pam_sunray.
 		# On platforms that don't need this, utxunlock is not installed
-		if [[ -x $ADMIN_LIB/utxunlock ]] 
+		if [ -x $ADMIN_LIB/utxunlock ]
 		then
 			$ADMIN_BIN/utaction -c $ADMIN_LIB/utxunlock &
 		fi
